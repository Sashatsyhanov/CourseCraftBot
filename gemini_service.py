import google.generativeai as genai
import logging
import os
from dotenv import load_dotenv
import hashlib
from database import get_resources_by_tags  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞

load_dotenv()
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))

logger = logging.getLogger(__name__)

def generate_plan(skill, experience, goal, edit_request=""):
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        prompt = (
            f"–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. "
            f"–°–æ–∑–¥–∞–π –ø–ª–∞–Ω –∫—É—Ä—Å–∞ –∏–∑ 7 —É—Ä–æ–∫–æ–≤ –¥–ª—è –Ω–∞–≤—ã–∫–∞ '{skill}'. "
            f"–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞: '{experience}'. –¶–µ–ª—å: '{goal}'. {edit_request}. "
            f"–ü—Ä–∏–º–µ–Ω—è–π –∑–∞–∫–æ–Ω 80/20: —Ñ–æ–∫—É—Å –Ω–∞ 20% —Ç–µ–º, –¥–∞—é—â–∏—Ö 80% —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. "
            f"–ö–∞–∂–¥—ã–π —É—Ä–æ–∫ ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ (50-70 —Å–∏–º–≤–æ–ª–æ–≤). "
            f"–í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ 7 —Å—Ç—Ä–æ–∫ –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞."
        )
        response = model.generate_content(prompt).text.strip().split("\n")
        lessons = [line.strip() for line in response if line.strip()]
        if len(lessons) != 7:
            logger.warning(f"–ü–ª–∞–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç {len(lessons)} —É—Ä–æ–∫–æ–≤ –≤–º–µ—Å—Ç–æ 7, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º")
            return lessons[:7] if len(lessons) > 7 else lessons + ["–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–∫"] * (7 - len(lessons))
        return lessons
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞: {str(e)}")
        return None

def generate_course(skill, experience, goal, preferences, plan, generated_lessons=None):
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        plan_str = "\n".join([f"–î–µ–Ω—å {i+1}: {title}" for i, title in enumerate(plan)])
        exclude_lessons = ""
        if generated_lessons:
            exclude_lessons = (
                "–ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–ª–µ–¥—É—é—â–∏–µ —É—Ä–æ–∫–∏ (—Ö–µ—à–∏):\n" +
                "\n".join([f"- {hashlib.md5(lesson.encode()).hexdigest()}" for lesson in generated_lessons]) +
                "\n–ì–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è."
            )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        resources = get_resources_by_tags(skill.lower())
        resource_content = ""
        if resources:
            resource_content = "–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:\n"
            for title, author, res_type, content in resources:
                resource_content += f"- {res_type.capitalize()} '{title}' –æ—Ç {author}: {content[:200]}...\n"
            resource_content += "–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —É—Ä–æ–∫–∏, –∞–¥–∞–ø—Ç–∏—Ä—É—è –ø–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.\n"
        
        prompt = (
            f"–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º, —Å–æ–∑–¥–∞—é—â–∏–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–µ –∫—É—Ä—Å—ã. "
            f"–†–∞–∑—Ä–∞–±–æ—Ç–∞–π 7-–¥–Ω–µ–≤–Ω—ã–π –∫—É—Ä—Å –ø–æ –Ω–∞–≤—ã–∫—É '{skill}' –¥–ª—è —Ü–µ–ª–∏ '{goal}'. "
            f"–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞: {experience}. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {preferences}.\n\n"
            f"### –ü—Ä–∏–Ω—Ü–∏–ø 80/20\n"
            f"- –î–∞–π 20% –∑–Ω–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–µ—Å–ø–µ—á–∞—Ç 80% —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.\n"
            f"- –£–±–µ—Ä–∏ –≤—Å—ë –ª–∏—à–Ω–µ–µ, –æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ.\n\n"
            f"### –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n"
            f"- –ö—É—Ä—Å –¥–ª–∏—Ç—Å—è 7 –¥–Ω–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π –ø–ª–∞–Ω:\n{plan_str}\n\n"
            f"### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞\n"
            f"- –ö–∞–∂–¥—ã–π —É—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–æ—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n"
            f"  <b>–î–µ–Ω—å X: [–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞]</b>\n"
            f"  <b>–ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ üéØ</b>: 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ, —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π).\n"
            f"  <b>–û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥ üöÄ</b>: –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è, 3-4 —Å–æ–≤–µ—Ç–∞. –í –∫–æ–Ω—Ü–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å: '–ù–µ —É–≤–µ—Ä–µ–Ω? –ó–∞–¥–∞–π –º–Ω–µ –≤–æ–ø—Ä–æ—Å!'.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä üåü</b>: –†–µ–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Å –¥–µ—Ç–∞–ª—è–º–∏.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 1 ‚úçÔ∏è</b>: –ü—Ä–æ—Å—Ç–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 2 ‚úçÔ∏è</b>: –ó–∞–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è.\n"
            f"  üí° –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç: –ö–æ—Ä–æ—Ç–∫–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π.\n"
            f"  –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å!\n"
            f"  –ü–æ –ª—é–±–æ–º—É –ø–æ–≤–æ–¥—É –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ –≤–æ–ø—Ä–æ—Å! üöÄ\n"
            f"  <b>–°–ø—Ä–∞—à–∏–≤–∞–π –æ–±–æ –≤—Å—ë–º! ü§ì</b>\n"
            f"- –ù–µ –¥—É–±–ª–∏—Ä—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.\n"
            f"### –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è\n"
            f"- –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤: –ø—Ä–æ—Å—Ç—ã–µ –æ—Å–Ω–æ–≤—ã. –î–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ: –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏. –î–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö: —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏.\n"
            f"- –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è ({preferences}) –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –∏ —Å—Ç–∏–ª–µ.\n"
            f"- –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π Python, –µ—Å–ª–∏ —è–∑—ã–∫ –Ω–µ —É–∫–∞–∑–∞–Ω.\n\n"
            f"### –§–æ—Ä–º–∞—Ç\n"
            f"- –î–ª–∏–Ω–∞ —É—Ä–æ–∫–∞: 1800-2400 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω).\n"
            f"- –ò—Å–ø–æ–ª—å–∑—É–π <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> —Å <b></b> —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.\n"
            f"- –ù–∏–∫–∞–∫–∏—Ö ** –∏–ª–∏ * –≤ —Ç–µ–∫—Å—Ç–µ.\n"
            f"- –î–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫–∏ (üéØ, üöÄ, üåü, ‚úçÔ∏è) –∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º.\n"
            f"- –ü–∏—à–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–∞–∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫.\n"
            f"- –†–∞–∑–¥–µ–ª—è–π —É—Ä–æ–∫–∏ —Å–∏–º–≤–æ–ª–æ–º '---'.\n"
            f"- –ù–µ —É–∫–∞–∑—ã–≤–∞–π –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π.\n"
            f"{resource_content if resource_content else '–ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π –∫—É—Ä—Å —Å –Ω—É–ª—è.'}\n"
            f"{exclude_lessons}"
        )
        response = model.generate_content(prompt).text.strip()
        logger.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç Gemini –¥–ª—è –∫—É—Ä—Å–∞: {response[:500]}...")
        lessons = [lesson.strip() for lesson in response.split("---") if lesson.strip()]
        if len(lessons) != 7:
            logger.warning(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(lessons)} —É—Ä–æ–∫–æ–≤ –≤–º–µ—Å—Ç–æ 7, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º")
            while len(lessons) < 7:
                lessons.append(
                    f"<b>–î–µ–Ω—å {len(lessons) + 1}: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –∫ '{skill}'</b>\n"
                    f"<b>–ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ üéØ</b>: –¢—ã –±–ª–∏–∑–æ–∫ –∫ —Ü–µ–ª–∏ '{goal}' ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–π!\n"
                    f"<b>–û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥ üöÄ</b>: –ü—Ä–∞–∫—Ç–∏–∫—É–π '{skill}' –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –ù–µ —É–≤–µ—Ä–µ–Ω? –ó–∞–¥–∞–π –º–Ω–µ –≤–æ–ø—Ä–æ—Å!\n"
                    f"<b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä üåü</b>: –ü—Ä–∏–º–µ–Ω–∏ '{skill}' –≤ –∂–∏–∑–Ω–∏.\n"
                    f"<b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 1 ‚úçÔ∏è</b>: –°–¥–µ–ª–∞–π –ø—Ä–æ—Å—Ç–æ–π —à–∞–≥.\n"
                    f"<b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 2 ‚úçÔ∏è</b>: –ó–∞–∫—Ä–µ–ø–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n"
                    f"üí° –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç: –ü–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.\n"
                    f"–ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å!\n"
                    f"–ü–æ –ª—é–±–æ–º—É –ø–æ–≤–æ–¥—É –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ –≤–æ–ø—Ä–æ—Å! üöÄ\n"
                    f"<b>–°–ø—Ä–∞—à–∏–≤–∞–π –æ–±–æ –≤—Å—ë–º! ü§ì</b>"
                )
            lessons = lessons[:7]
        return lessons
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—É—Ä—Å–∞: {str(e)}")
        return None

def answer_question(question, context=""):
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        prompt = (
            f"–¢—ã ‚Äî –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –ö–æ–Ω—Ç–µ–∫—Å—Ç: {context}\n"
            f"–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å: '{question}'.\n"
            f"–ü—Ä–∏–º–µ–Ω—è–π –∑–∞–∫–æ–Ω 80/20: 20% –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è 80% –ø–æ–Ω–∏–º–∞–Ω–∏—è.\n"
            f"–¢–µ–∫—Å—Ç ‚Äî 300-500 —Å–∏–º–≤–æ–ª–æ–≤, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π.\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> —Å <b></b> –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤, –Ω–∏–∫–∞–∫–∏—Ö ** –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.\n"
            f"–î–æ–±–∞–≤–ª—è–π —Å–º–∞–π–ª–∏–∫–∏ (üéØ, üöÄ, üåü, ‚úçÔ∏è). –ù–µ –¥–µ–ª–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —É—Ä–æ–∫–∞, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç—å."
        )
        response = model.generate_content(prompt).text.strip()
        logger.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç Gemini –Ω–∞ –≤–æ–ø—Ä–æ—Å: {response}")
        return response
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å: {str(e)}")
        return (
            f"<b>–û–π, –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π!</b> üéØ –Ø –ø–æ–º–æ–≥—É! –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑, –∏ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–º–µ—Å—Ç–µ. ‚úçÔ∏è"
        )

def generate_course_suggestions(skill):
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        prompt = (
            f"–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏. –ü—Ä–µ–¥–ª–æ–∂–∏ 3 –∏–¥–µ–∏ –¥–ª—è –∫—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ '{skill}'. "
            f"–ö–∞–∂–¥–∞—è –∏–¥–µ—è ‚Äî —Å—Ç—Ä–æ–∫–∞ (30-50 —Å–∏–º–≤–æ–ª–æ–≤). "
            f"–í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ 3 —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞."
        )
        response = model.generate_content(prompt).text.strip().split("\n")
        suggestions = [suggestion.strip() for suggestion in response if suggestion.strip()]
        if len(suggestions) != 3:
            logger.warning(f"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(suggestions)} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ 3, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º")
            return suggestions[:3] if len(suggestions) > 3 else suggestions + ["–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å"] * (3 - len(suggestions))
        return suggestions
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {str(e)}")
        return None

def update_lesson(skill, experience, goal, preferences, current_lesson, edit_request, day):
    try:
        model = genai.GenerativeModel("gemini-1.5-flash")
        current_title = current_lesson.split('\n')[0].replace("<b>", "").replace("</b>", "").split(": ")[1].strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        resources = get_resources_by_tags(skill.lower())
        resource_content = ""
        if resources:
            resource_content = "–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:\n"
            for title, author, res_type, content in resources:
                resource_content += f"- {res_type.capitalize()} '{title}' –æ—Ç {author}: {content[:200]}...\n"
            resource_content += "–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –≤ —É—Ä–æ–∫, –∞–¥–∞–ø—Ç–∏—Ä—É—è –ø–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.\n"
        
        prompt = (
            f"–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –æ–±—É—á–µ–Ω–∏–∏ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. "
            f"–û–±–Ω–æ–≤–∏ —É—Ä–æ–∫ –ø–æ –Ω–∞–≤—ã–∫—É '{skill}' —Å —É—á—ë—Ç–æ–º –ø–æ–∂–µ–ª–∞–Ω–∏—è: '{edit_request}'. "
            f"–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞: {experience}. –¶–µ–ª—å: {goal}. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: {preferences}. "
            f"–¢–µ–∫—É—â–∏–π —É—Ä–æ–∫:\n{current_lesson}\n"
            f"–ü—Ä–∏–º–µ–Ω—è–π –∑–∞–∫–æ–Ω 80/20: 20% –∑–Ω–∞–Ω–∏–π –¥–ª—è 80% —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.\n"
            f"–°–æ—Ö—Ä–∞–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞: '<b>–î–µ–Ω—å {day + 1}: {current_title}</b>'.\n"
            f"### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—Ä–æ–∫–∞\n"
            f"- –£—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–æ—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n"
            f"  <b>–î–µ–Ω—å X: [–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞]</b>\n"
            f"  <b>–ö—Ä–∞—Ç–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ üéØ</b>: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ, —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π).\n"
            f"  <b>–û—Å–Ω–æ–≤–Ω–æ–π —à–∞–≥ üöÄ</b>: –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è, 3-4 —Å–æ–≤–µ—Ç–∞. –í –∫–æ–Ω—Ü–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å: '–ù–µ —É–≤–µ—Ä–µ–Ω? –ó–∞–¥–∞–π –º–Ω–µ –≤–æ–ø—Ä–æ—Å!'.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä üåü</b>: –†–µ–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Å –¥–µ—Ç–∞–ª—è–º–∏.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 1 ‚úçÔ∏è</b>: –ü—Ä–æ—Å—Ç–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.\n"
            f"  <b>–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ 2 ‚úçÔ∏è</b>: –ó–∞–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.\n"
            f"  üí° –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç: –ö–æ—Ä–æ—Ç–∫–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π.\n"
            f"  –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã ‚Äî —è –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å!\n"
            f"  –ü–æ –ª—é–±–æ–º—É –ø–æ–≤–æ–¥—É –º–æ–∂–µ—à—å –∑–∞–¥–∞—Ç—å –º–Ω–µ –≤–æ–ø—Ä–æ—Å! üöÄ\n"
            f"  <b>–°–ø—Ä–∞—à–∏–≤–∞–π –æ–±–æ –≤—Å—ë–º! ü§ì</b>\n"
            f"- –ù–µ –¥—É–±–ª–∏—Ä—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.\n"
            f"### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ\n"
            f"- –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —à–∞–≥–∞—Ö –¥–ª—è '{edit_request}'.\n"
            f"- –î–ª–∏–Ω–∞: 1800-2400 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω).\n"
            f"- –ò—Å–ø–æ–ª—å–∑—É–π <b>–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> —Å <b></b> –¢–û–õ–¨–ö–û –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.\n"
            f"- –ù–∏–∫–∞–∫–∏—Ö ** –∏–ª–∏ * –≤ —Ç–µ–∫—Å—Ç–µ.\n"
            f"- –ü–∏—à–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.\n"
            f"{resource_content if resource_content else '–ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –Ω–µ—Ç, –æ–±–Ω–æ–≤–∏ —É—Ä–æ–∫ —Å –Ω—É–ª—è.'}"
        )
        response = model.generate_content(prompt).text.strip()
        logger.info(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç Gemini –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞: {response[:500]}...")
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É
        lesson_length = len(response)
        if lesson_length < 1800 or lesson_length > 2400:
            logger.warning(f"–î–ª–∏–Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —É—Ä–æ–∫–∞ {lesson_length} —Å–∏–º–≤–æ–ª–æ–≤, –æ–∂–∏–¥–∞–ª–æ—Å—å 1800-2400")
        return response
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Ä–æ–∫–∞: {str(e)}")
        return current_lesson

__all__ = ["generate_plan", "generate_course", "answer_question", "generate_course_suggestions", "update_lesson"]